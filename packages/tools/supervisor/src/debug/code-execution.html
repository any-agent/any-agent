<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Code Execution Tool - Debug</title>
	<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<style>
		* { box-sizing: border-box; }
		body { font-family: system-ui, -apple-system, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
		h1 { color: #333; }
		.container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
		@media (max-width: 768px) { .container { grid-template-columns: 1fr; } }
		.panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
		label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
		input, select, textarea { width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 14px; }
		textarea { font-family: 'Monaco', 'Menlo', monospace; min-height: 200px; }
		button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 600; }
		button:hover { background: #0056b3; }
		button:disabled { background: #ccc; cursor: not-allowed; }
		.result { margin-top: 20px; }
		.result pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; border: 1px solid #ddd; }
		.error { color: #dc3545; background: #f8d7da; padding: 10px; border-radius: 4px; border: 1px solid #f5c6cb; }
		.success { color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; border: 1px solid #c3e6cb; }
		.artifact-list { list-style: none; padding: 0; }
		.artifact-list li { padding: 8px; background: #f8f9fa; margin-bottom: 5px; border-radius: 4px; }
		.artifact-list a { color: #007bff; text-decoration: none; }
		.artifact-list a:hover { text-decoration: underline; }
		.loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
		@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		h3 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
		.empty-content { color: #dc3545; font-style: italic; padding: 15px; background: #f8f9fa; border-radius: 4px; border: 1px solid #ddd; }
		.json-display { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 4px; overflow-x: auto; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; line-height: 1.5; max-height: 400px; overflow-y: auto; }
		.json-key { color: #e06c75; }
		.json-string { color: #98c379; }
		.json-number { color: #d19a66; }
		.json-boolean { color: #56b6c2; }
		.json-null { color: #c678dd; }
	</style>
</head>
<body x-data="debugApp()">
	<h1>üíª Code Execution Tool - Debug</h1>
	<p style="text-align: center; color: #666; margin-top: -10px; margin-bottom: 30px;">
		<a href="/debug" style="color: #007bff; text-decoration: none;">‚Üê Back to tools</a>
	</p>

	<div class="container">
		<div class="panel">
			<h3>Input</h3>
			<form @submit.prevent="runCode">
				<label for="sessionId">Session ID</label>
				<input type="text" id="sessionId" x-model="sessionId" placeholder="e.g., session-123" required>

				<label for="language">Language</label>
				<select id="language" x-model="language">
					<option value="bash">Bash</option>
					<option value="python">Python</option>
					<option value="node">Node.js</option>
					<option value="bun">Bun</option>
				</select>

				<label for="filename">Filename</label>
				<input type="text" id="filename" x-model="filename" placeholder="e.g., script.py" required>

				<label for="timeout">Timeout (seconds, max: 900)</label>
				<input type="number" id="timeout" x-model.number="timeout" placeholder="30" min="1" max="900" required>

				<label for="code">Code</label>
				<textarea id="code" x-model="code" placeholder="Enter your code here..." required></textarea>

				<button type="submit" :disabled="loading">
					<span x-show="!loading">‚ñ∂ Run Code</span>
					<span x-show="loading"><span class="loading"></span> Running...</span>
				</button>
			</form>
		</div>

		<div class="panel">
			<h3>Output</h3>

			<div x-show="error" class="error" x-text="error"></div>

			<div x-show="result && !error">
				<div class="success" style="margin-bottom: 15px;">
					‚úì Job completed<br>
					<strong>Session:</strong> <span x-text="result?.sessionId"></span><br>
					<strong>Job ID:</strong> <span x-text="result?.id"></span><br>
					<strong>Exit Code:</strong> <span x-text="result?.exitCode"></span>
				</div>

				<div x-show="result?.artifacts?.inputs && Object.keys(result.artifacts.inputs).length > 0">
					<h4 style="margin-top: 20px;">üì• Input Artifacts</h4>
					<ul class="artifact-list">
						<template x-for="[name, url] in Object.entries(result?.artifacts?.inputs || {})" :key="name">
							<li>
								<strong x-text="name"></strong> -
								<a :href="url" target="_blank">Download</a>
							</li>
						</template>
					</ul>
				</div>

				<div x-show="result?.artifacts?.outputs && Object.keys(result.artifacts.outputs).length > 0">
					<h4 style="margin-top: 20px;">üì§ Output Artifacts</h4>
					<ul class="artifact-list">
						<template x-for="[name, url] in Object.entries(result?.artifacts?.outputs || {})" :key="name">
							<li>
								<strong x-text="name"></strong> -
								<a :href="url" target="_blank">Download</a>
								<span x-show="name === 'stdout' || name === 'stderr'">
									(<a href="#" @click.prevent="fetchArtifact(url, name)">view</a>)
								</span>
							</li>
						</template>
					</ul>
				</div>

				<div x-show="artifactName">
					<h4 style="margin-top: 20px;" x-text="'Content: ' + artifactName"></h4>
					<pre x-show="artifactContent && !isEmptyContent" x-text="artifactContent"></pre>
					<div x-show="isEmptyContent" class="empty-content">no content</div>
				</div>
			</div>

			<div x-show="!result && !error && !loading" style="color: #999; text-align: center; padding: 40px;">
				Run some code to see results here
			</div>
		</div>
	</div>

	<div class="container" style="margin-top: 20px;">
		<div class="panel">
			<h3>Raw Input</h3>
			<div x-show="rawInput">
				<pre class="json-display" x-html="formatJson(rawInput)"></pre>
			</div>
			<div x-show="!rawInput" style="color: #999; text-align: center; padding: 40px;">
				No request sent yet
			</div>
		</div>

		<div class="panel">
			<h3>Raw Output</h3>
			<div x-show="rawOutput">
				<pre class="json-display" x-html="formatJson(rawOutput)"></pre>
			</div>
			<div x-show="!rawOutput" style="color: #999; text-align: center; padding: 40px;">
				No response received yet
			</div>
		</div>
	</div>

	<script>
		function debugApp() {
			return {
				sessionId: 'debug-session-' + Date.now(),
				language: 'python',
				filename: 'script.py',
				timeout: 30,
				code: 'print("Hello from the supervisor!")',
				loading: false,
				result: null,
				error: null,
				artifactContent: '',
				artifactName: '',
				isEmptyContent: false,
				rawInput: null,
				rawOutput: null,

				async runCode() {
					this.loading = true;
					this.error = null;
					this.result = null;
					this.artifactContent = '';
					this.artifactName = '';
					this.isEmptyContent = false;

					const requestBody = {
						tool: 'code_execution',
						sessionId: this.sessionId,
						language: this.language,
						code: this.code,
						filename: this.filename,
						timeout: this.timeout
					};

					// Store raw input
					this.rawInput = requestBody;

					try {
						const response = await fetch('/tools/execute', {
							method: 'POST',
							headers: { 'Content-Type': 'application/json' },
							body: JSON.stringify(requestBody)
						});

						const data = await response.json();

						// Store raw output
						this.rawOutput = data;

						if (!response.ok) {
							this.error = data.error || 'Request failed: ' + response.status;
							if (data.details) {
								this.error += '\n' + JSON.stringify(data.details, null, 2);
							}
						} else {
							this.result = data;
						}
					} catch (err) {
						this.error = 'Network error: ' + err.message;
					} finally {
						this.loading = false;
					}
				},

				async fetchArtifact(url, name) {
					this.artifactName = name;
					this.artifactContent = 'Loading...';
					this.isEmptyContent = false;
					try {
						const response = await fetch(url);
						const text = await response.text();
						if (text.trim() === '') {
							this.isEmptyContent = true;
							this.artifactContent = '';
						} else {
							this.isEmptyContent = false;
							this.artifactContent = text;
						}
					} catch (err) {
						this.isEmptyContent = false;
						this.artifactContent = 'Error loading artifact: ' + err.message;
					}
				},

				formatJson(obj) {
					if (!obj) return '';
					const json = JSON.stringify(obj, null, 2);

					// Syntax highlight the JSON
					return json
						.replace(/&/g, '&amp;')
						.replace(/</g, '&lt;')
						.replace(/>/g, '&gt;')
						.replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
						.replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
						.replace(/: (\d+)/g, ': <span class="json-number">$1</span>')
						.replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
						.replace(/: (null)/g, ': <span class="json-null">$1</span>');
				}
			}
		}
	</script>
</body>
</html>
